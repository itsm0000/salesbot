<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØªØ¸Ø± - ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ¤–</span>
                <h1>Ù…Ù†ØªØ¸Ø±</h1>
            </div>
            <p class="subtitle">ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ Ø§Ù„Ø°ÙƒÙŠ</p>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Chat Section -->
            <section class="chat-section">
                <div class="section-header">
                    <h2>ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                    <button id="clearChat" class="btn-secondary">Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="welcome-message">
                        <p>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ! Ø£Ù†Ø§ Ù…Ù†ØªØ¸Ø±ØŒ ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.</p>
                        <p>Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† ÙˆØ±Ø§Ø­ Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ!</p>
                    </div>
                </div>

                <div class="input-section">
                    <textarea 
                        id="messageInput" 
                        placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† Ù‡Ù†Ø§... Ù…Ø«Ø§Ù„: Ø´Ù„ÙˆÙ†ÙƒÙ…ØŒ Ø´Ù†Ùˆ Ø³Ø¹Ø± Ø§Ù„Ù…ØµØ¨Ø§Ø­ Ø§Ù„Ø°ÙƒÙŠØŸ"
                        rows="3"
                    ></textarea>
                    <button id="sendBtn" class="btn-primary">
                        <span class="btn-text">Ø¥Ø±Ø³Ø§Ù„</span>
                        <span class="btn-loading" style="display: none;">â³</span>
                    </button>
                </div>
            </section>

            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Products Section -->
                <section class="products-section">
                    <div class="section-header">
                        <h2>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
                        <span id="productCount" class="badge">0</span>
                    </div>
                    <div class="products-list" id="productsList">
                        <p class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                    </div>
                </section>

                <!-- Stats Section -->
                <section class="stats-section">
                    <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="messageCount">0</span>
                            <span class="stat-label">Ø±Ø³Ø§Ø¦Ù„</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="avgConfidence">--</span>
                            <span class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø«Ù‚Ø©</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="avgResponseTime">--</span>
                            <span class="stat-label">ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯ (ms)</span>
                        </div>
                    </div>
                </section>
            </aside>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>Ù…Ù†ØªØ¸Ø± v0.1.0 | Ø¨ØºØ¯Ø§Ø¯ Ù„Ù„Ø¥Ù†Ø§Ø±Ø©</p>
        </footer>
    </div>

    <script>
        // State
        let messageCount = 0;
        let totalConfidence = 0;
        let totalResponseTime = 0;
        const customerId = 'web_user_' + Date.now();

        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearChatBtn = document.getElementById('clearChat');
        const productsList = document.getElementById('productsList');
        const productCount = document.getElementById('productCount');

        // Load products on page load
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                
                productCount.textContent = data.total;
                
                if (data.products.length === 0) {
                    productsList.innerHTML = '<p class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>';
                    return;
                }

                productsList.innerHTML = data.products.map(product => `
                    <div class="product-card" data-id="${product.id}">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${product.price.toLocaleString('ar-IQ')} Ø¯ÙŠÙ†Ø§Ø±</div>
                        <div class="product-stock ${product.stock > 0 ? 'in-stock' : 'out-of-stock'}">
                            ${product.stock > 0 ? `Ù…ØªÙˆÙØ± (${product.stock})` : 'Ù†ÙØ°'}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                productsList.innerHTML = '<p class="error">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>';
            }
        }

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Show loading
            sendBtn.querySelector('.btn-text').style.display = 'none';
            sendBtn.querySelector('.btn-loading').style.display = 'inline';
            sendBtn.disabled = true;

            // Add user message to chat
            addMessageToChat('user', message);
            messageInput.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        customer_id: customerId,
                        platform: 'manual'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Add AI response to chat
                    addMessageToChat('assistant', data.response, {
                        confidence: data.confidence,
                        time: data.processing_time_ms,
                        actions: data.actions,
                        flags: data.flags
                    });

                    // Update stats
                    updateStats(data.confidence, data.processing_time_ms);
                } else {
                    addMessageToChat('error', 'Ø®Ø·Ø£: ' + (data.detail || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessageToChat('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            } finally {
                // Hide loading
                sendBtn.querySelector('.btn-text').style.display = 'inline';
                sendBtn.querySelector('.btn-loading').style.display = 'none';
                sendBtn.disabled = false;
            }
        }

        // Add message to chat
        function addMessageToChat(role, content, metadata = {}) {
            // Remove welcome message if present
            const welcome = chatContainer.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;

            let metadataHtml = '';
            if (role === 'assistant' && metadata.confidence !== undefined) {
                const confidencePercent = Math.round(metadata.confidence * 100);
                metadataHtml = `
                    <div class="message-meta">
                        <span class="confidence" title="Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©">ğŸ¯ ${confidencePercent}%</span>
                        <span class="time" title="ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">â±ï¸ ${metadata.time}ms</span>
                        ${metadata.actions?.length ? `<span class="actions">ğŸ“Œ ${metadata.actions.join(', ')}</span>` : ''}
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="message-role">${role === 'user' ? 'ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†' : role === 'assistant' ? 'ğŸ¤– Ù…Ù†ØªØ¸Ø±' : 'âš ï¸'}</div>
                <div class="message-content">${content}</div>
                ${metadataHtml}
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Update stats
        function updateStats(confidence, responseTime) {
            messageCount++;
            totalConfidence += confidence;
            totalResponseTime += responseTime;

            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('avgConfidence').textContent = 
                Math.round((totalConfidence / messageCount) * 100) + '%';
            document.getElementById('avgResponseTime').textContent = 
                Math.round(totalResponseTime / messageCount);
        }

        // Clear chat
        async function clearChat() {
            try {
                await fetch(`/api/conversation/${customerId}`, { method: 'DELETE' });
                chatContainer.innerHTML = `
                    <div class="welcome-message">
                        <p>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ! Ø£Ù†Ø§ Ù…Ù†ØªØ¸Ø±ØŒ ÙˆÙƒÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.</p>
                        <p>Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø²Ø¨ÙˆÙ† ÙˆØ±Ø§Ø­ Ø£Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¨Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ!</p>
                    </div>
                `;
                // Reset stats
                messageCount = 0;
                totalConfidence = 0;
                totalResponseTime = 0;
                document.getElementById('messageCount').textContent = '0';
                document.getElementById('avgConfidence').textContent = '--';
                document.getElementById('avgResponseTime').textContent = '--';
            } catch (error) {
                console.error('Error clearing chat:', error);
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        clearChatBtn.addEventListener('click', clearChat);

        // Initialize
        loadProducts();
    </script>
</body>
</html>
